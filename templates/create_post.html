{% extends "base.html" %}

{% block content %}
<div class="create-post">
    <div class="back-button">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
    </div>

    <h2>üìù –ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>

    <div id="userAlert" class="alert alert-warning" style="display: none;">
        ‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π
    </div>

    <form id="postForm">
        <div class="form-group">
            <label for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
            <input type="text" id="title" name="title" required maxlength="200" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ">
        </div>

        <div class="form-group">
            <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
            <select id="category" name="category" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                {% for value, label in categories %}
                    <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="content">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
            <textarea id="content" name="content" required rows="5" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è"></textarea>
        </div>

        <div class="form-group">
            <label for="price">–¶–µ–Ω–∞</label>
            <input type="text" id="price" name="price" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1000 —Ä—É–±., –ë–µ—Å–ø–ª–∞—Ç–Ω–æ, –î–æ–≥–æ–≤–æ—Ä–Ω–∞—è">
        </div>

        <div class="form-group">
            <label for="contact_info">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è *</label>
            <input type="text" id="contact_info" name="contact_info" required placeholder="–¢–µ–ª–µ–≥—Ä–∞–º @username, —Ç–µ–ª–µ—Ñ–æ–Ω, –∏–ª–∏ –¥—Ä—É–≥–∞—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('postForm');
    const userAlert = document.getElementById('userAlert');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userData = JSON.parse(localStorage.getItem('telegram_user') || '{}');
    if (!userData.id) {
        userAlert.style.display = 'block';
        form.style.opacity = '0.5';
        form.querySelectorAll('input, select, textarea, button').forEach(element => {
            element.disabled = true;
        });
        return;
    }

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;

        submitBtn.disabled = true;
        submitBtn.textContent = '–ü—É–±–ª–∏–∫—É–µ–º...';

        try {
            const formData = new FormData(this);
            const userData = JSON.parse(localStorage.getItem('telegram_user') || '{}');

            const response = await fetch('/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: formData.get('title'),
                    category: formData.get('category'),
                    content: formData.get('content'),
                    price: formData.get('price'),
                    contact_info: formData.get('contact_info'),
                    user_data: userData
                })
            });

            const result = await response.json();

            if (result.success) {
                if (window.showTelegramNotification) {
                    window.showTelegramNotification(result.message, 'info');
                } else {
                    alert(result.message);
                }
                setTimeout(() => {
                    window.location.href = '/post/' + result.post_id;
                }, 1000);
            } else {
                const errorMsg = result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                if (window.showTelegramNotification) {
                    window.showTelegramNotification(errorMsg, 'error');
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ' + errorMsg);
                }
            }
        } catch (error) {
            const errorMsg = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
            if (window.showTelegramNotification) {
                window.showTelegramNotification(errorMsg, 'error');
            } else {
                alert(errorMsg);
            }
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });
});
</script>

<style>
.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: bold;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
}

.alert {
    padding: 1rem;
    border-radius: 5px;
    margin-bottom: 1rem;
}

.alert-warning {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}
</style>
{% endblock %}