{% extends "base.html" %}

{% block content %}
<div class="edit-post">
    <div class="back-button">
        <a href="{{ url_for('my_posts') }}" class="btn btn-secondary">‚Üê –ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</a>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>

    <h2>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>

    <div id="userAlert" class="alert alert-warning" style="display: none;">
        ‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π
    </div>

    <div id="postNotFound" class="alert alert-danger" style="display: none;">
        ‚ùå –û–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –µ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    </div>

    <form id="editPostForm" style="display: none;">
        <input type="hidden" id="postId" value="{{ post_id }}">

        <div class="form-group">
            <label for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
            <input type="text" id="title" name="title" required maxlength="200" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ">
            <div class="char-counter"><span id="titleCount">0</span>/200</div>
        </div>

        <div class="form-group">
            <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
            <select id="category" name="category" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                {% for value, label in categories %}
                    <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="content">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
            <textarea id="content" name="content" required rows="6" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è"></textarea>
            <div class="char-counter"><span id="contentCount">0</span>/2000</div>
        </div>

        <div class="form-group">
            <label for="price">–¶–µ–Ω–∞</label>
            <input type="text" id="price" name="price" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1000 —Ä—É–±., –ë–µ—Å–ø–ª–∞—Ç–Ω–æ, –î–æ–≥–æ–≤–æ—Ä–Ω–∞—è">
            <div class="help-text">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ —Ü–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞</div>
        </div>

        <div class="form-group">
            <label for="contact_info">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è *</label>
            <input type="text" id="contact_info" name="contact_info" required placeholder="–¢–µ–ª–µ–≥—Ä–∞–º @username, —Ç–µ–ª–µ—Ñ–æ–Ω, –∏–ª–∏ –¥—Ä—É–≥–∞—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
        </div>

        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="is_active" name="is_active" checked>
                <span class="checkmark"></span>
                ‚úÖ –ê–∫—Ç–∏–≤–Ω–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –æ–±—â–µ–º —Å–ø–∏—Å–∫–µ)
            </label>
            <div class="help-text">–°–Ω–∏–º–∏—Ç–µ –≥–∞–ª–æ—á–∫—É —á—Ç–æ–±—ã –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            <button type="button" id="deleteBtn" class="btn btn-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</button>
            <a href="{{ url_for('my_posts') }}" class="btn btn-secondary">‚ùå –û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>

    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner"></div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏—è...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('editPostForm');
    const userAlert = document.getElementById('userAlert');
    const postNotFound = document.getElementById('postNotFound');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const deleteBtn = document.getElementById('deleteBtn');
    const postId = document.getElementById('postId').value;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userData = JSON.parse(localStorage.getItem('telegram_user') || '{}');
    if (!userData.id) {
        userAlert.style.display = 'block';
        loadingSpinner.style.display = 'none';
        return;
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
    loadPostData(postId, userData);

    // –°—á–µ—Ç—á–∏–∫–∏ —Å–∏–º–≤–æ–ª–æ–≤
    const titleInput = document.getElementById('title');
    const contentInput = document.getElementById('content');
    const titleCount = document.getElementById('titleCount');
    const contentCount = document.getElementById('contentCount');

    titleInput.addEventListener('input', function() {
        titleCount.textContent = this.value.length;
    });

    contentInput.addEventListener('input', function() {
        contentCount.textContent = this.value.length;
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        await updatePost(postId, userData);
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
    deleteBtn.addEventListener('click', function() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
            deletePost(postId, userData);
        }
    });
});

async function loadPostData(postId, userData) {
    try {
        const response = await fetch(`/api/post/${postId}?user_data=${encodeURIComponent(JSON.stringify(userData))}`);
        const result = await response.json();

        if (result.success) {
            const post = result.post;

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏
            document.getElementById('title').value = post.title;
            document.getElementById('category').value = post.category;
            document.getElementById('content').value = post.content;
            document.getElementById('price').value = post.price || '';
            document.getElementById('contact_info').value = post.contact_info;
            document.getElementById('is_active').checked = post.is_active;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            document.getElementById('titleCount').textContent = post.title.length;
            document.getElementById('contentCount').textContent = post.content.length;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('editPostForm').style.display = 'block';
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('Error loading post:', error);
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('postNotFound').style.display = 'block';
    }
}

async function updatePost(postId, userData) {
    const form = document.getElementById('editPostForm');
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;

    submitBtn.disabled = true;
    submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    submitBtn.classList.add('loading');

    try {
        const formData = new FormData(form);

        const response = await fetch(`/api/post/${postId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: formData.get('title'),
                category: formData.get('category'),
                content: formData.get('content'),
                price: formData.get('price'),
                contact_info: formData.get('contact_info'),
                is_active: formData.get('is_active') === 'on',
                user_data: userData
            })
        });

        const result = await response.json();

        if (result.success) {
            const message = '–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!';
            if (window.showTelegramNotification) {
                window.showTelegramNotification(message, 'info');
            } else {
                alert(message);
            }

            setTimeout(() => {
                window.location.href = '/my_posts';
            }, 1500);
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('Error updating post:', error);
        const errorMsg = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ' + error.message;
        if (window.showTelegramNotification) {
            window.showTelegramNotification(errorMsg, 'error');
        } else {
            alert(errorMsg);
        }
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        submitBtn.classList.remove('loading');
    }
}

async function deletePost(postId, userData) {
    const deleteBtn = document.getElementById('deleteBtn');
    const originalText = deleteBtn.textContent;

    deleteBtn.disabled = true;
    deleteBtn.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ...';
    deleteBtn.classList.add('loading');

    try {
        const response = await fetch(`/api/post/${postId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_data: userData
            })
        });

        const result = await response.json();

        if (result.success) {
            const message = '–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ!';
            if (window.showTelegramNotification) {
                window.showTelegramNotification(message, 'info');
            } else {
                alert(message);
            }

            setTimeout(() => {
                window.location.href = '/my_posts';
            }, 1500);
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('Error deleting post:', error);
        const errorMsg = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message;
        if (window.showTelegramNotification) {
            window.showTelegramNotification(errorMsg, 'error');
        } else {
            alert(errorMsg);
        }

        deleteBtn.disabled = false;
        deleteBtn.textContent = originalText;
        deleteBtn.classList.remove('loading');
    }
}
</script>

<style>
.edit-post {
    max-width: 600px;
    margin: 0 auto;
    padding: 1rem;
}

.back-button {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: bold;
    color: #333;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.char-counter {
    text-align: right;
    font-size: 0.8rem;
    color: #666;
    margin-top: 0.3rem;
}

.help-text {
    font-size: 0.8rem;
    color: #666;
    margin-top: 0.3rem;
    font-style: italic;
}

.checkbox-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-weight: normal;
}

.checkbox-label input[type="checkbox"] {
    display: none;
}

.checkmark {
    width: 20px;
    height: 20px;
    border: 2px solid #ddd;
    border-radius: 3px;
    margin-right: 0.5rem;
    position: relative;
    transition: all 0.3s ease;
}

.checkbox-label input[type="checkbox"]:checked + .checkmark {
    background: #667eea;
    border-color: #667eea;
}

.checkbox-label input[type="checkbox"]:checked + .checkmark::after {
    content: '‚úì';
    position: absolute;
    color: white;
    font-size: 14px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    flex-wrap: wrap;
}

.form-actions .btn {
    flex: 1;
    min-width: 140px;
}

.btn-danger {
    background: #dc3545;
    color: white;
    border: none;
}

.btn-danger:hover {
    background: #c82333;
    transform: translateY(-2px);
}

.loading-spinner {
    text-align: center;
    padding: 3rem;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading {
    opacity: 0.6;
    pointer-events: none;
}

.alert {
    padding: 1rem;
    border-radius: 5px;
    margin-bottom: 1rem;
}

.alert-warning {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

.alert-danger {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

@media (max-width: 768px) {
    .form-actions {
        flex-direction: column;
    }

    .form-actions .btn {
        width: 100%;
    }

    .back-button {
        flex-direction: column;
    }
}
</style>
{% endblock %}