{% extends "base.html" %}

{% block content %}
<div class="post-detail">
    <div class="back-button">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <a href="{{ url_for('posts') }}" class="btn btn-secondary">‚Üê –ö —Å–ø–∏—Å–∫—É</a>
    </div>

    <!-- –î–û–ë–ê–í–õ–ï–ù –û–¢–õ–ê–î–û–ß–ù–´–ô –ë–õ–û–ö -->
    <div style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px;">
        <small>–û—Ç–ª–∞–¥–∫–∞:
            –ê–≤—Ç–æ—Ä ID: {{ post.author.id if post.author else '–ù–µ—Ç –∞–≤—Ç–æ—Ä–∞' }},
            –†–µ–π—Ç–∏–Ω–≥: {{ post.author.average_rating if post.author else 0 }},
            –û—Ç–∑—ã–≤—ã: {{ post.author.reviews_count if post.author else 0 }}
        </small>
    </div>

    <article class="post-full">
        <h1>{{ post.title }}</h1>

        <div class="post-meta">
            <span>üìç {{ post.category }}</span>
            <span>üìÖ {{ post.created_at.strftime('%d.%m.%Y –≤ %H:%M') }}</span>
            {% if post.price %}<span>üí∞ {{ post.price }}</span>{% endif %}
        </div>

        <div class="post-content">
            <p>{{ post.content }}</p>
        </div>

        {% if post.contact_info %}
        <div class="contact-info">
            <h3>üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã:</h3>
            <p>{{ post.contact_info }}</p>
        </div>
        {% endif %}

        <div class="post-author">
            <div class="author-info">
                <strong>–ê–≤—Ç–æ—Ä: {{ post.author.first_name if post.author else '–ê–Ω–æ–Ω–∏–º' }}</strong>
                {% if post.author %}
                    {% set user_rating = post.author.average_rating %}
                    {% set user_reviews_count = post.author.reviews_count %}
                    {% if user_reviews_count > 0 %}
                    <div class="author-rating">
                        <span class="rating-stars">
                            {% for i in range(1, 6) %}
                                {% if i <= user_rating %}
                                    ‚≠ê
                                {% else %}
                                    ‚òÜ
                                {% endif %}
                            {% endfor %}
                        </span>
                        <span class="rating-text">
                            {{ "%.1f"|format(user_rating) }} ({{ user_reviews_count }}
                            {% if user_reviews_count == 1 %}–æ—Ç–∑—ã–≤{% elif user_reviews_count in [2,3,4] %}–æ—Ç–∑—ã–≤–∞{% else %}–æ—Ç–∑—ã–≤–æ–≤{% endif %})
                        </span>
                    </div>
                    {% else %}
                    <div class="no-reviews">–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </article>

    <!-- –ë–ª–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ -->
    <div class="reviews-section">
        <h3>üìù –û—Ç–∑—ã–≤—ã ({{ reviews|length }})</h3>

        {% if can_review %}
        <div class="add-review-form">
            <h4>–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h4>
            <form id="reviewForm">
                <input type="hidden" name="post_id" value="{{ post.id }}">

                <div class="rating-input">
                    <label>–û—Ü–µ–Ω–∫–∞ *</label>
                    <div class="stars">
                        {% for i in range(5, 0, -1) %}
                        <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" required>
                        <label for="star{{ i }}">‚≠ê</label>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                    <textarea id="comment" name="comment" rows="3" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –æ–ø—ã—Ç–µ..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
            </form>
        </div>
        {% elif not user_data %}
        <div class="alert alert-warning">
            <p>‚ö†Ô∏è –ß—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤, –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram</p>
        </div>
        {% endif %}

        <div class="reviews-list">
            {% for review in reviews %}
            <div class="review-card">
                <div class="review-header">
                    <div class="reviewer">
                        <strong>{{ review.buyer.first_name if review.buyer else '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}</strong>
                        {% if review.buyer and review.buyer.username %}
                        <span>@{{ review.buyer.username }}</span>
                        {% endif %}
                    </div>
                    <div class="review-meta">
                        <span class="review-stars">
                            {% for i in range(1, 6) %}
                                {% if i <= review.rating %}
                                    ‚≠ê
                                {% else %}
                                    ‚òÜ
                                {% endif %}
                            {% endfor %}
                        </span>
                        <span class="review-date">{{ review.created_at.strftime('%d.%m.%Y') }}</span>
                    </div>
                </div>
                {% if review.comment %}
                <div class="review-comment">
                    <p>{{ review.comment }}</p>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="no-posts">
                <p>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="post-actions">
        <a href="{{ url_for('index') }}" class="btn btn-primary">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <a href="{{ url_for('posts') }}" class="btn btn-secondary">–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</a>
        <a href="{{ url_for('create_post') }}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ—ë</a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const reviewForm = document.getElementById('reviewForm');

    if (reviewForm) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∑–≤–µ–∑–¥
        const stars = reviewForm.querySelectorAll('input[name="rating"]');
        stars.forEach(star => {
            star.addEventListener('change', function() {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–≤–µ–∑–¥
                const rating = parseInt(this.value);
                stars.forEach((s, index) => {
                    const label = s.nextElementSibling;
                    if (parseInt(s.value) <= rating) {
                        label.style.color = '#ffc107';
                    } else {
                        label.style.color = '#ccc';
                    }
                });
            });
        });

        reviewForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const rating = formData.get('rating');
            const comment = formData.get('comment');
            const postId = formData.get('post_id');

            if (!rating) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É');
                return;
            }

            const userData = JSON.parse(localStorage.getItem('telegram_user') || '{}');

            if (!userData.id) {
                alert('–î–ª—è –æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram');
                return;
            }

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;

            submitBtn.disabled = true;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
            submitBtn.classList.add('loading');

            try {
                const response = await fetch('/api/review', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        post_id: postId,
                        rating: parseInt(rating),
                        comment: comment,
                        user_data: userData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    if (window.showTelegramNotification) {
                        window.showTelegramNotification('–û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'info');
                    } else {
                        alert('–û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
                    }
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    const errorMsg = result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    if (window.showTelegramNotification) {
                        window.showTelegramNotification('–û—à–∏–±–∫–∞: ' + errorMsg, 'error');
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + errorMsg);
                    }
                }
            } catch (error) {
                console.error('Review submission error:', error);
                const errorMsg = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
                if (window.showTelegramNotification) {
                    window.showTelegramNotification(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                submitBtn.classList.remove('loading');
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ü–≤–µ—Ç–∞ –∑–≤–µ–∑–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const starLabels = reviewForm.querySelectorAll('input[name="rating"] + label');
        starLabels.forEach(star => {
            star.style.color = '#ccc';
        });
    }
});
</script>

<style>
/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ä–µ–π—Ç–∏–Ω–≥–∞, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–º style.css */

.author-rating {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 8px;
}

.rating-stars {
    font-size: 1.2rem;
}

.rating-text {
    color: #666;
    font-size: 0.9rem;
}

.reviews-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #e9ecef;
}

.add-review-form {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 2rem;
}

.add-review-form h4 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: #333;
}

.rating-input {
    margin-bottom: 1rem;
}

.rating-input label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.rating-input .stars {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
    gap: 0.3rem;
}

.rating-input input[type="radio"] {
    display: none;
}

.rating-input label[for^="star"] {
    cursor: pointer;
    font-size: 2rem;
    transition: color 0.2s;
    color: #ccc;
}

.rating-input input[type="radio"]:checked ~ label[for^="star"],
.rating-input label[for^="star"]:hover,
.rating-input label[for^="star"]:hover ~ label[for^="star"] {
    color: #ffc107;
}

.review-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 1.2rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.8rem;
    flex-wrap: wrap;
    gap: 10px;
}

.reviewer {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.reviewer strong {
    color: #333;
}

.reviewer span {
    color: #666;
    font-size: 0.8rem;
}

.review-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 5px;
}

.review-stars {
    font-size: 1.1rem;
}

.review-date {
    color: #666;
    font-size: 0.8rem;
}

.review-comment {
    margin-top: 0.8rem;
    padding-top: 0.8rem;
    border-top: 1px solid #f0f0f0;
    line-height: 1.5;
    color: #555;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 600px) {
    .review-header {
        flex-direction: column;
        align-items: flex-start;
    }

    .review-meta {
        align-items: flex-start;
        margin-top: 0.5rem;
    }

    .rating-input .stars {
        justify-content: space-between;
    }

    .rating-input label[for^="star"] {
        font-size: 1.8rem;
    }
}
</style>
{% endblock %}