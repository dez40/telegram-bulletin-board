{% extends "base.html" %}

{% block content %}
<div class="post-detail">
    <div class="back-button">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <a href="{{ url_for('posts') }}" class="btn btn-secondary">‚Üê –ö —Å–ø–∏—Å–∫—É</a>
    </div>

    <!-- –î–û–ë–ê–í–õ–ï–ù –û–¢–õ–ê–î–û–ß–ù–´–ô –ë–õ–û–ö -->
    <div style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px;">
        <small>–û—Ç–ª–∞–¥–∫–∞:
            –ê–≤—Ç–æ—Ä ID: {{ post.author.id if post.author else '–ù–µ—Ç –∞–≤—Ç–æ—Ä–∞' }},
            –†–µ–π—Ç–∏–Ω–≥: {{ post.author.average_rating if post.author else 0 }},
            –û—Ç–∑—ã–≤—ã: {{ post.author.reviews_count if post.author else 0 }}
        </small>
    </div>

    <article class="post-full">
        <h1>{{ post.title }}</h1>

        <div class="post-meta">
            <span>üìç {{ post.category }}</span>
            <span>üìÖ {{ post.created_at.strftime('%d.%m.%Y –≤ %H:%M') }}</span>
            {% if post.price %}<span>üí∞ {{ post.price }}</span>{% endif %}
        </div>

        <div class="post-content">
            <p>{{ post.content }}</p>
        </div>

        {% if post.contact_info %}
        <div class="contact-info">
            <h3>üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã:</h3>
            <p>{{ post.contact_info }}</p>
        </div>
        {% endif %}

        <div class="post-author">
            <div class="author-info">
                <strong>–ê–≤—Ç–æ—Ä: {{ post.author.first_name if post.author else '–ê–Ω–æ–Ω–∏–º' }}</strong>
                {% if post.author %}
                    {% set user_rating = post.author.average_rating %}
                    {% set user_reviews_count = post.author.reviews_count %}
                    {% if user_reviews_count > 0 %}
                    <div class="author-rating">
                        <span class="rating-stars">
                            {% for i in range(1, 6) %}
                                {% if i <= user_rating %}
                                    ‚≠ê
                                {% else %}
                                    ‚òÜ
                                {% endif %}
                            {% endfor %}
                        </span>
                        <span class="rating-text">
                            {{ "%.1f"|format(user_rating) }} ({{ user_reviews_count }}
                            {% if user_reviews_count == 1 %}–æ—Ç–∑—ã–≤{% elif user_reviews_count in [2,3,4] %}–æ—Ç–∑—ã–≤–∞{% else %}–æ—Ç–∑—ã–≤–æ–≤{% endif %})
                        </span>
                    </div>
                    {% else %}
                    <div class="no-reviews">–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </article>

    <!-- –ë–ª–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ -->
    <div class="reviews-section">
        <h3>üìù –û—Ç–∑—ã–≤—ã ({{ reviews|length }})</h3>

        {% if can_review %}
        <div class="add-review-form">
            <h4>–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h4>
            <form id="reviewForm">
                <input type="hidden" name="post_id" value="{{ post.id }}">

                <div class="rating-input">
                    <label>–û—Ü–µ–Ω–∫–∞ *</label>
                    <div class="stars">
                        {% for i in range(5, 0, -1) %}
                        <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" required>
                        <label for="star{{ i }}">‚≠ê</label>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                    <textarea id="comment" name="comment" rows="3" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –æ–ø—ã—Ç–µ..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
            </form>
        </div>
        {% elif not user_data %}
        <div class="alert alert-warning">
            <p>‚ö†Ô∏è –ß—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤, –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram</p>
        </div>
        {% endif %}

        <div class="reviews-list">
            {% for review in reviews %}
            <div class="review-card">
                <div class="review-header">
                    <div class="reviewer">
                        <strong>{{ review.buyer.first_name if review.buyer else '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}</strong>
                        {% if review.buyer and review.buyer.username %}
                        <span>@{{ review.buyer.username }}</span>
                        {% endif %}
                    </div>
                    <div class="review-meta">
                        <span class="review-stars">
                            {% for i in range(1, 6) %}
                                {% if i <= review.rating %}
                                    ‚≠ê
                                {% else %}
                                    ‚òÜ
                                {% endif %}
                            {% endfor %}
                        </span>
                        <span class="review-date">{{ review.created_at.strftime('%d.%m.%Y') }}</span>
                    </div>
                </div>
                {% if review.comment %}
                <div class="review-comment">
                    <p>{{ review.comment }}</p>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="no-posts">
                <p>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="post-actions">
        <a href="{{ url_for('index') }}" class="btn btn-primary">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <a href="{{ url_for('posts') }}" class="btn btn-secondary">–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</a>
        <a href="{{ url_for('create_post') }}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ—ë</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/post_detail.js') }}"></script>
{% endblock %}